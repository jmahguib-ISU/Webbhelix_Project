1. Take a look at this attached script. This will take a phylip file of unlinked SNPs and return a nexus file for input into BEAUTi. You need to supply a traits file (see example below) that maps individuals to OTUs. Then you specify the maximum number of individuals you want per OTU. For any OTU above this threshold, the script will subsample the correct number of individuals. This is either done randomly or by taking the individuals that have the highest coverage. The command line to run the script is:

Set up Python 2.7.10 (default, Jun  1 2015, 18:05:38) onto computer

python SNPtoSNAPP.py Infile.snps traits seqs_per_otu random/length

#Infile.snps ó your phylip unlinked snp infile

#seqs_per_otu ó specify the max number of individuals per OTU

#random/length ó if you have to subsample individuals, do you want this done randomly or based on coverage


Mac-KIMs-MacBook-Pro:SNAPP_scripts Mac_kim$ 

python SNPtoSNAPP_ipyrad.py CG_156_P94_SinSNP_NewID.phy popmap_cg_dr_156_4species_traits.txt 10 length

python SNPtoSNAPP_ipyrad.py CG_156_P94_SinSNP_NewID1.phy popmap_cgdr_156_traits_4_species1.txt 8 length

python SNPtoSNAPP_ipyrad.py CG_156_P94_SinSNP_NewID1.phy popmap_cg_dr_156ind_10Sites.txt 4 length

python SNPtoSNAPP_ipyrad.py CG_156_P94_SinSNP_NewID1.phy popmap_cg_dr_156ind_10Sites.txt 4 random

python SNPtoSNAPP_ipyrad.py CG_156_P94_SinSNP_NewID1.phy popmap_cgdr_156_traits_4_species1.txt 4 length

python SNPtoSNAPP_ipyrad.py CG_156_P94_SinSNP_NewID1.phy popmap_cg_dr_156ind_10Sites_NoDromus.txt 4 length

python SNPtoSNAPP_ipyrad.py catalog38_P167_184ind_from279_revised.phy popmap_184_3Lampsilis_Species.txt 4 length

python SNPtoSNAPP_ipyrad.py Cyprogenia_New_303_152_223IND.phy popmap_cg_dr_303_152_223IND.txt 4 length



2. As for the BEAUTi troubles, what version of Beast are you using? After you open BEAUTi, add the SNAPP package via File 
-> Manage Packages, the SNAPP template should be available for use (File -> Template -> SNAPP). 
Then you setup your analysis and execute the xml with BEAST.

Operaton:
Open Beauti
Go to Template SNAPP in file
Select "Add alignment"
Select SNAPP new file made by python script
In model parameter: select Cal mutation rates
Unselect "Include non-polymorphic sites"
Select "Use Log Likelihood Correction"
Leave Prior as default
MCMC: Chain Length: 1,000,000 Store Every: 100 ,,so 10,000 select
Save the file as filename.xml
Close Beauti and open Beast
Select the saved xml file
And RUN!

2-1. Check results

Tracer: Download Tracer and open snap.log file generated by Beast program, Take a look at tutorials at https://beast.community/analysing_beast_output
Trace files generated by SNAPP were inspected and convergence of chain by checking Effective Sample Size (ESS) for various variablesusing was evaluated using the program Tracer (http://tree.bio.ed.ac.uk/software/tracer).

TreeAnnotator:
TreeAnnotator will summarize the posterior distribution of species trees and identify the topology with
the best posterior support, and summarize the divergence times for each node in the tree. Launch the TreeAnnotator
program.

3. Preparing input files for Model Selection;
Use xml file made by method above
Open your XML file in a text editor. 
Search and replace the opening run statement (located about half way through
the file) with an mcmc statement by changing “<run ...>” into “<mcmc ...>”. Next, type a new closing mcmc
statement, “</mcmc>”, just before the closing run statement, “</run>”, located at the end of the file.
Now you are ready to insert the path sampling commands. You will need to insert the following block of text into
your XML file immediately above the opening “<mcmc ...>” ’ element:

<run spec='beast.inference.PathSampler'
chainLength="10000"
alpha='0.3'
rootdir='/work/LAS/kjroe-lab/texas/snapp/Model1'
burnInPercentage='50'
preBurnin="1000"
deleteOldLogs='true'
nrOfSteps='24'>
cd $(dir)
java -cp $(java.class.path) beast.app.beastapp.BeastMain $(resume/overwrite) -java -seed $(seed) beast.xml

Important: If you copy and paste this section into your XML file, be sure to check that the symbols paste correctly.
The quote symbols (“ ‘ ’ ") don’t copy as they should, and these will cause problems. Also, make sure that the root
directory path (rootdir) exists on your computer.

3-1. 

4. In pronto cluster

ssh kkim@pronto.las.iastate.edu


For BEAST Tree construction

#!/bin/bash
#SBATCH --ntasks=50
#SBATCH --partition=biocrunch
#SBATCH --nodes=1
#SBATch --mem=128G
#SBATCH --time=5-00:00:00
#SBATCH --error=/work/LAS/kjroe-lab/kkim/snapp/snapp_out.%J.err}

module load beast2/2.5.2-kfp4pck

module load libbeagle/3.1.2-nxszy75 

packagemanager -add SNAPP

beast -beagle -threads 50 /work/LAS/kjroe-lab/kkim/snapp/CG_156_P94_SinSNP_NewID_snapp_10ind_L.xml

touch snapp.sh
nano snapp.sh
sbatch snapp.sh 

#!/bin/bash
#SBATCH --ntasks=100
#SBATCH --partition=biocrunch
#SBATCH --nodes=1
#SBATch --mem=128G
#SBATCH --time=15-00:00:00
#SBATCH --error=/work/LAS/kjroe-lab/kkim/snapp/cyprogenia/snapp_out.%J.err}

module load beast2/2.5.2-kfp4pck

module load libbeagle/3.1.2-nxszy75

packagemanager -add SNAPP

beast -beagle -threads 100 /work/LAS/kjroe-lab/kkim/snapp/cyprogenia/CG_156_P94_SinSNP_NewID1_snapp_4ind_L_NoDromus_10M.xml


#!/bin/bash

#Submit this script with: sbatch thefilename

#SBATCH -t 1:00:00   # walltime
#SBATCH -N 1   # number of nodes in this job
#SBATCH -n 1   # total number of processor cores in this job
#SBATCH -J "pack"   # job name
#SBATCH --mail-user=jsatler@iastate.edu   # email address
#SBATCH --mail-type=END


# LOAD MODULES, INSERT CODE, AND RUN YOUR PROGRAMS HERE
packagemanager -add SNAPP

#!/bin/bash
#SBATCH --ntasks=30
#SBATCH --partition=biocrunch
#SBATCH --nodes=1
#SBATch --mem=64G
#SBATCH --time=5-00:00:00
#SBATCH --error=/work/LAS/kjroe-lab/kkim/snapp/snapp_out.%J.err}

module load beast2/2.5.2-kfp4pck
module load libbeagle/3.1.2-nxszy75
packagemanager -add SNAPP

beast -beagle -threads 30 /work/LAS/kjroe-lab/kkim/snapp/CG_156_P94_SinSNP_NewID1_snapp_4ind_L_1M_CL.xml

TRACER

#!/bin/bash

#SBATCH --ntasks=50

#SBATCH --partition=biocrunch

#SBATCH --nodes=1

#SBATch --mem=128G

#SBATCH --time=15-00:00:00

#SBATCH --error=/work/LAS/kjroe-lab/kkim/snapp/run1/run1_snapp_out.%J.err}

module load beast2/2.5.2-kfp4pck

beast -threads 50 /work/LAS/kjroe-lab/kkim/snapp/run1/run1.xml


For Model selection

#!/bin/bash

#SBATCH --ntasks=50

#SBATCH --partition=biocrunch

#SBATCH --nodes=1

#SBATch --mem=128G

#SBATCH --time=15-00:00:00

#SBATCH --error=/work/LAS/kjroe-lab/kkim/snapp/Model1_3species/test/Model1_1000_snapp_out.%J.err}

module load beast2/2.5.2-kfp4pck

packagemanager -add SNAPP

packagemanager -add MODEL_SELECTION

beast -threads 50 /work/LAS/kjroe-lab/kkim/snapp/Model1_3species/test/Model1_3species_1000.xml


#!/bin/bash

#SBATCH --ntasks=50

#SBATCH --partition=biocrunch

#SBATCH --nodes=1

#SBATch --mem=128G

#SBATCH --time=15-00:00:00

#SBATCH --error=/work/LAS/kjroe-lab/kkim/snapp/Model1_3species/test/Model1_1000_snapp_out.%J.err}

module load beast2/2.5.2-kfp4pck

packagemanager -add SNAPP

packagemanager -add MODEL_SELECTION

packagemanager -add PATHSAMPLER

beast -threads 50 /work/LAS/kjroe-lab/kkim/snapp/Model1_3species/test/Model1_3species_1000.xml


#!/bin/bash

#SBATCH --ntasks=50

#SBATCH --partition=biocrunch

#SBATCH --nodes=1

#SBATch --mem=128G

#SBATCH --time=15-00:00:00

#SBATCH --error=/work/LAS/kjroe-lab/texas/snapp/Model0/Model0_10000_snapp_out.%J.err}

module load beast2/2.5.2-kfp4pck

packagemanager -add SNAPP

packagemanager -add MODEL_SELECTION

packagemanager -add PATHSAMPLER

beast -threads 50 /work/LAS/kjroe-lab/texas/snapp/Model0/Model0_3species.xml


#!/bin/bash

#SBATCH --ntasks=50

#SBATCH --partition=biocrunch

#SBATCH --nodes=1

#SBATch --mem=128G

#SBATCH --time=15-00:00:00

module load beast2/2.5.2-kfp4pck

packagemanager -add SNAPP

packagemanager -add MODEL_SELECTION

beast -threads 50 /work/LAS/kjroe-lab/texas/snapp/Model8/Model8_hydieana_5species_brateata_4species_bermani_1species.xml


#!/bin/bash

#SBATCH --ntasks=50

#SBATCH --partition=biocrunch

#SBATCH --nodes=1

#SBATch --mem=128G

#SBATCH --time=10-00:00:00

module load beast2/2.5.2-kfp4pck

packagemanager -add SNAPP

packagemanager -add MODEL_SELECTION

beast -threads 50 /work/LAS/kjroe-lab/kkim/snapp/cyprogenia/Model0/Model0_2cluster_CG_156_P94_SinSNP_NewID1_snapp_4ind_L_1M_Beast_2_5-Dromus.xml

#!/bin/bash

#SBATCH --ntasks=50

#SBATCH --partition=biocrunch

#SBATCH --nodes=1

#SBATch --mem=128G

#SBATCH --time=10-00:00:00

module load beast2/2.5.2-kfp4pck

packagemanager -add SNAPP

packagemanager -add MODEL_SELECTION

beast -threads 50 /work/LAS/kjroe-lab/kkim/snapp/cyprogenia/Model1/Model1_3cluster_CG_156_P94_SinSNP_NewID1_snapp_4ind_L_1M_Beast_2_5-Dromus.xml


#!/bin/bash

#SBATCH --ntasks=50

#SBATCH --partition=biocrunch

#SBATCH --nodes=1

#SBATch --mem=128G

#SBATCH --time=10-00:00:00

module load beast2/2.5.2-kfp4pck

packagemanager -add SNAPP

packagemanager -add MODEL_SELECTION

beast -threads 50 /work/LAS/kjroe-lab/kkim/snapp/cyprogenia/Model6/Model6_4cluster_CG_156_P94_SinSNP_NewID1_snapp_4ind_L_1M_Beast_2_5-Dromus.xml
